<!DOCTYPE html>
<html lang="zh-CN" data-theme="eva-00">

<head>
  <meta charset="UTF-8" />
  <title>åå°ç®¡ç† - NERV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/public/css/base.css" />
  <script defer src="/public/js/theme.js"></script>
  <style>
    /* Admin specific overrides */
    :root {
      --admin-sidebar-w: 0px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-control {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      color: var(--text-primary);
      border-radius: 4px;
      font-family: inherit;
    }

    .form-control:focus {
      outline: 2px solid var(--accent-color);
    }

    textarea.form-control {
      min-height: 300px;
      resize: vertical;
    }

    .post-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      transition: background 0.2s;
    }

    .post-item:hover {
      background: var(--bg-primary);
    }

    .post-info h4 {
      margin: 0 0 5px 0;
      font-size: 1.1rem;
    }

    .post-meta-small {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .status-select {
      padding: 5px;
      border-radius: 4px;
      border: 1px solid var(--border-color);
    }
  </style>
</head>

<body>
  <header>
    <h1>NERV COMMAND CENTER</h1>
    <nav>
      <a href="/" target="_blank">æŸ¥çœ‹ç«™ç‚¹</a>
      <a href="#" onclick="logout()">é€€å‡ºç™»å½•</a>
    </nav>
  </header>

  <main class="container">
    <div style="display:grid; grid-template-columns: 1fr; gap: 30px;">

      <!-- Editor Section -->
      <section id="editor-section" class="post-card">
        <h2 id="form-title">å‘å¸ƒæŒ‡ä»¤</h2>
        <form id="post-form">
          <input type="hidden" id="post-id" name="id" />

          <div class="form-group">
            <input type="text" id="post-title" name="title" class="form-control" placeholder="è¾“å…¥æ ‡é¢˜..." required />
          </div>

          <div class="form-group">
            <select id="post-status" name="status" class="form-control" style="width: auto; display: inline-block;">
              <option value="draft">è‰ç¨¿ (Draft)</option>
              <option value="published">å‘å¸ƒ (Published)</option>
            </select>
            <span style="font-size:0.8rem; color:var(--text-secondary); margin-left:10px;">é€‰æ‹©çŠ¶æ€ä»¥å†³å®šæ˜¯å¦å…¬å¼€</span>
          </div>

          <div class="form-group">
            <div class="editor-toolbar">
              <button type="button" class="toolbar-btn" onclick="wrapTag('<b>', '</b>')">B</button>
              <button type="button" class="toolbar-btn" onclick="wrapTag('<i>', '</i>')">I</button>
              <button type="button" class="toolbar-btn" onclick="wrapTag('<u>', '</u>')">U</button>
              <button type="button" class="toolbar-btn" onclick="wrapTag('<h3>', '</h3>')">H3</button>
              <button type="button" class="toolbar-btn" onclick="insertLink()">ğŸ”—</button>
              <button type="button" class="toolbar-btn" onclick="insertImage()">ğŸ–¼ï¸</button>
              <select id="font-size-select" class="toolbar-select" onchange="applyFontSize()">
                <option value="">å­—å·</option>
                <option value="0.9rem">å°</option>
                <option value="1rem">æ ‡å‡†</option>
                <option value="1.2rem">ä¸­</option>
                <option value="1.4rem">å¤§</option>
                <option value="1.8rem">è¶…å¤§</option>
              </select>
              <input id="font-color-picker" class="toolbar-color" type="color" value="#00e676" onchange="applyColor()"/>
              <button type="button" class="toolbar-btn" onclick="applyAlign('left')">â¬…ï¸</button>
              <button type="button" class="toolbar-btn" onclick="applyAlign('center')">â¬‡ï¸</button>
              <button type="button" class="toolbar-btn" onclick="applyAlign('right')">â¡ï¸</button>
              <button type="button" class="toolbar-btn" onclick="wrapTag('<hr/>')">â–</button>
            </div>
            <textarea id="post-content" name="content" class="editor-textarea" placeholder="è¾“å…¥å†…å®¹ (æ”¯æŒ HTML)..."
              required></textarea>
          </div>

          <div class="form-group" style="display:flex; gap:10px;">
            <button type="submit" class="btn btn-primary">æäº¤ / æ›´æ–°</button>
            <button type="button" class="btn" onclick="resetForm()" style="background:#ccc;color:#333;">é‡ç½®</button>
          </div>
        </form>
      </section>

      <!-- List Section -->
      <section>
        <h3 style="border-bottom:2px solid var(--accent-color); padding-bottom:10px; margin-bottom:20px;">æ¡£æ¡ˆåˆ—è¡¨</h3>
        <div id="posts-list" style="border:1px solid var(--border-color); border-radius:8px; overflow:hidden;">
          <div style="padding:20px; text-align:center;">è¯»å–ä¸­...</div>
        </div>
      </section>

    </div>
  </main>

  <footer>
    <div class="theme-switcher">
      <div class="theme-btn" data-theme="eva-00"></div>
      <div class="theme-btn" data-theme="eva-01"></div>
      <div class="theme-btn" data-theme="eva-02"></div>
    </div>
  </footer>

  <script>
    const API_URL = '/api/posts';

    function wrapTag(openTag, closeTag = '') {
      const textarea = document.getElementById('post-content');
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const text = textarea.value;
      const selected = text.substring(start, end);
      const next = text.substring(0, start) + openTag + selected + closeTag + text.substring(end);
      textarea.value = next;
      textarea.focus();
      const cursor = start + openTag.length + selected.length + closeTag.length;
      textarea.selectionStart = cursor;
      textarea.selectionEnd = cursor;
    }

    function insertLink() {
      const url = prompt('è¾“å…¥é“¾æ¥åœ°å€', 'https://');
      if (url) wrapTag(`<a href="${url}" target="_blank">`, '</a>');
    }

    function insertImage() {
      const url = prompt('è¾“å…¥å›¾ç‰‡åœ°å€', 'https://');
      if (url) wrapTag(`<img src="${url}" alt="image" style="max-width:100%;" />`);
    }

    function applyColor() {
      const color = document.getElementById('font-color-picker').value;
      if (color) wrapTag(`<span style="color:${color}">`, '</span>');
    }

    function applyFontSize() {
      const size = document.getElementById('font-size-select').value;
      if (size) wrapTag(`<span style="font-size:${size}">`, '</span>');
    }

    function applyAlign(align) {
      wrapTag(`<div style="text-align:${align}">`, '</div>');
    }

    async function fetchPosts() {
      try {
        const res = await fetch(API_URL);
        const posts = await res.json();
        posts.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)); // Desc
        renderList(posts);
      } catch (e) {
        console.error(e);
      }
    }

    function renderList(posts) {
      const list = document.getElementById('posts-list');
      if (posts.length === 0) {
        list.innerHTML = '<div style="padding:20px;text-align:center;">æš‚æ— æ•°æ®</div>';
        return;
      }
      list.innerHTML = posts.map(p => `
        <div class="post-item">
          <div class="post-info">
            <h4>${escapeHtml(p.title)}</h4>
            <div class="post-meta-small">
              <span class="status-badge status-${p.status || 'draft'}">${p.status === 'published' ? 'å·²å‘å¸ƒ' : 'è‰ç¨¿'}</span>
              <span>${new Date(p.created_at).toLocaleDateString()}</span>
            </div>
          </div>
          <div class="admin-actions">
            <button class="btn btn-small" style="background:var(--accent-color);color:#000;" onclick='editPost(${JSON.stringify(p).replace(/'/g, "&#39;")})'>ç¼–è¾‘</button>
            <button class="btn btn-small btn-danger" onclick="deletePost('${p.id}')">åˆ é™¤</button>
          </div>
        </div>
      `).join('');
    }

    // Form Handler
    document.getElementById('post-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('post-id').value;
      const title = document.getElementById('post-title').value;
      const content = document.getElementById('post-content').value;
      const status = document.getElementById('post-status').value;

      const body = { title, content, status };
      const method = id ? 'PUT' : 'POST';
      const url = id ? `${API_URL}/${id}` : API_URL;

      try {
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        if (res.ok) {
          resetForm();
          fetchPosts();
          alert(id ? 'æ›´æ–°æˆåŠŸ' : 'å‘å¸ƒæˆåŠŸ');
        } else {
          alert('æ“ä½œå¤±è´¥');
        }
      } catch (err) {
        console.error(err);
        alert('ç½‘ç»œé”™è¯¯');
      }
    });

    function editPost(post) {
      document.getElementById('form-title').innerText = 'ç¼–è¾‘æŒ‡ä»¤: ' + post.id.substring(0, 8);
      document.getElementById('post-id').value = post.id;
      document.getElementById('post-title').value = post.title;
      document.getElementById('post-content').value = post.content;
      document.getElementById('post-status').value = post.status || 'draft';
      document.getElementById('editor-section').scrollIntoView({ behavior: 'smooth' });
    }

    async function deletePost(id) {
      if (!confirm('ç¡®è®¤åˆ é™¤è¯¥æ¡£æ¡ˆï¼Ÿæ­¤æ“ä½œä¸å¯é€†ã€‚')) return;
      try {
        const res = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
        if (res.ok) fetchPosts();
      } catch (e) { console.error(e); }
    }

    function resetForm() {
      document.getElementById('post-form').reset();
      document.getElementById('post-id').value = '';
      document.getElementById('form-title').innerText = 'å‘å¸ƒæŒ‡ä»¤';
    }

    async function logout() {
      await fetch('/api/logout', { method: 'POST' });
      window.location.href = '/login';
    }

    function escapeHtml(text) {
      if (!text) return '';
      return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    // Init
    document.addEventListener('DOMContentLoaded', fetchPosts);
  </script>
</body>

</html>
