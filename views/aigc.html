<!DOCTYPE html>
<html lang="zh-CN" data-theme="eva-00">
<head>
  <meta charset="UTF-8" />
  <title>AIGC Gallery - Eva Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/public/css/base.css" />
  <style>
    .gallery-grid { column-count: 2; column-gap: 20px; padding: 20px 0; }
    @media (max-width: 900px) { .gallery-grid { column-count: 1; } }
    .gallery-item { break-inside: avoid; margin-bottom: 20px; position: relative; background: #fff; border-radius: 8px; overflow: hidden; border: 1px solid #ddd; }
    .gallery-item img { width: 100%; height: auto; display: block; cursor: pointer; transition: opacity 0.3s; }
    .gallery-item img:hover { opacity: 0.9; }
    .alt-btn { position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,.6); color: #fff; border-radius: 4px; border: 1px solid rgba(255,255,255,.3); padding: 4px 8px; font-size: .75rem; cursor: pointer; z-index: 10; }
    
    /* Lightbox Controls */
    .lb-control { position: absolute; color: white; cursor: pointer; user-select: none; z-index: 3010; font-weight: bold; transition: 0.3s; background: rgba(0,0,0,0.5); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
    .lb-control:hover { background: rgba(255,255,255,0.2); }
    .lb-close { top: 20px; right: 20px; font-size: 24px; }
    .lb-prev { top: 50%; left: 20px; transform: translateY(-50%); font-size: 24px; }
    .lb-next { top: 50%; right: 20px; transform: translateY(-50%); font-size: 24px; }
    .lb-play { bottom: 20px; left: 50%; transform: translateX(-50%); font-size: 20px; }
    .active-play { background: rgba(0, 255, 0, 0.5) !important; color: #000; }
  </style>
</head>
<body>
  <header>
    <h1><a href="/" style="text-decoration:none;color:inherit">Eva Blog</a> / AIGC</h1>
    <nav><a href="/">首页</a> | <a href="/login">管理员登录</a></nav>
  </header>
  <main class="container">
    <div id="gallery" class="gallery-grid"></div>
    <div id="loading" class="loading-sentinel">SYSTEM SYNCING...</div>
  </main>
  <div id="alt-modal" class="modal" style="display:none;position:fixed;inset:0;z-index:3001;background:rgba(0,0,0,0.5);">
    <div class="modal-content" style="background:#fff;padding:20px;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:500px;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.3);">
      <span class="close-modal" style="cursor:pointer;float:right;font-size:20px;font-weight:bold;">×</span>
      <div id="alt-text-display" style="white-space:pre-wrap;margin-top:24px;max-height:60vh;overflow-y:auto;"></div>
      <button id="copy-alt-btn" class="copy-btn" style="margin-top:16px;padding:6px 12px;cursor:pointer;">复制内容</button>
    </div>
  </div>
  <div id="lightbox-modal" class="lightbox-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.95);justify-content:center;align-items:center;z-index:3000;">
    <span class="lb-control lb-close" title="Close">×</span>
    <span class="lb-control lb-prev" title="Previous">&#10094;</span>
    <span class="lb-control lb-next" title="Next">&#10095;</span>
    <span class="lb-control lb-play" title="Auto Play/Pause">▶</span>
    <img id="lightbox-img" src="" alt="Full View" style="max-width:90%;max-height:80%;border:2px solid #fff;box-shadow:0 0 40px rgba(0,0,0,.6); transition: opacity 0.3s;"/>
  </div>
  <footer>
    <div class="theme-switcher" aria-label="切换主题">
      <div class="theme-btn" data-theme="eva-00"></div>
      <div class="theme-btn" data-theme="eva-01"></div>
      <div class="theme-btn" data-theme="eva-02"></div>
    </div>
  </footer>
  <script>
    let page = 1, loading = false, hasMore = true;
    let isAdmin = false;
    let allImages = []; // Track all loaded images for navigation
    let currentIndex = -1;
    let slideshowInterval = null;

    const gallery = document.getElementById('gallery');
    const loadingEl = document.getElementById('loading');
    const altModal = document.getElementById('alt-modal');
    const altDisplay = document.getElementById('alt-text-display');
    const closeModal = document.querySelector('.close-modal');
    const copyAltBtn = document.getElementById('copy-alt-btn');
    
    const lightboxModal = document.getElementById('lightbox-modal');
    const lightboxImg = document.getElementById('lightbox-img');
    const lbClose = document.querySelector('.lb-close');
    const lbPrev = document.querySelector('.lb-prev');
    const lbNext = document.querySelector('.lb-next');
    const lbPlay = document.querySelector('.lb-play');

    const closeLightbox = () => { 
      lightboxModal.style.display = 'none'; 
      lightboxImg.src = ''; 
      stopSlideshow();
    };

    const openLightbox = (index) => {
      if (index >= 0 && index < allImages.length) {
        currentIndex = index;
        updateLightboxImage();
        lightboxModal.style.display = 'flex';
      }
    };

    const updateLightboxImage = () => {
      const img = allImages[currentIndex];
      lightboxImg.style.opacity = 0;
      setTimeout(() => {
        lightboxImg.src = img.url; // Always load full quality in lightbox
        lightboxImg.onload = () => { lightboxImg.style.opacity = 1; };
      }, 150);
    };

    const showNext = (e) => {
      if (e) e.stopPropagation();
      if (currentIndex < allImages.length - 1) {
        currentIndex++;
      } else {
        currentIndex = 0; // Loop back to start
      }
      updateLightboxImage();
    };

    const showPrev = (e) => {
      if (e) e.stopPropagation();
      if (currentIndex > 0) {
        currentIndex--;
      } else {
        currentIndex = allImages.length - 1; // Loop to end
      }
      updateLightboxImage();
    };

    const toggleSlideshow = (e) => {
      if (e) e.stopPropagation();
      if (slideshowInterval) {
        stopSlideshow();
      } else {
        startSlideshow();
      }
    };

    const startSlideshow = () => {
      lbPlay.classList.add('active-play');
      lbPlay.textContent = '❚❚'; // Pause symbol
      slideshowInterval = setInterval(() => {
        showNext();
      }, 3000); // 3 seconds per slide
    };

    const stopSlideshow = () => {
      lbPlay.classList.remove('active-play');
      lbPlay.textContent = '▶'; // Play symbol
      if (slideshowInterval) {
        clearInterval(slideshowInterval);
        slideshowInterval = null;
      }
    };

    // Lightbox Event Listeners
    lbClose.onclick = (e) => { e.stopPropagation(); closeLightbox(); };
    lbPrev.onclick = showPrev;
    lbNext.onclick = showNext;
    lbPlay.onclick = toggleSlideshow;
    
    // Close on background click
    lightboxModal.onclick = (e) => {
      if (e.target === lightboxModal) {
        closeLightbox();
      }
    };

    // Keyboard support
    document.addEventListener('keydown', (e) => {
      if (lightboxModal.style.display === 'flex') {
        if (e.key === 'Escape') closeLightbox();
        if (e.key === 'ArrowRight') showNext();
        if (e.key === 'ArrowLeft') showPrev();
        if (e.key === ' ') { e.preventDefault(); toggleSlideshow(); }
      }
    });

    // Check admin status on load
    fetch('/api/auth/status')
      .then(res => res.json())
      .then(data => {
        isAdmin = data.isAdmin;
      })
      .catch(console.error);

    function showAlt(imgData, itemEl) {
      // Clear previous content
      altDisplay.innerHTML = '';
      
      if (isAdmin) {
        // Edit mode
        const textarea = document.createElement('textarea');
        textarea.style.width = '100%';
        textarea.style.height = '150px';
        textarea.style.marginBottom = '10px';
        textarea.style.padding = '8px';
        textarea.value = imgData.alt || '';
        
        const saveBtn = document.createElement('button');
        saveBtn.className = 'btn btn-primary';
        saveBtn.textContent = '保存 / SAVE';
        saveBtn.onclick = async () => {
          try {
            const res = await fetch('/api/images/caption', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ filename: imgData.name, caption: textarea.value })
            });
            if (res.ok) {
              imgData.alt = textarea.value;
              alert('Saved!');
              altModal.style.display = 'none';
              // Update DOM if needed
              const imgEl = itemEl.querySelector('img');
              if (imgEl) imgEl.alt = textarea.value;
            } else {
              alert('Failed to save');
            }
          } catch (e) {
            console.error(e);
            alert('Error saving');
          }
        };
        
        altDisplay.appendChild(textarea);
        altDisplay.appendChild(saveBtn);
        copyAltBtn.style.display = 'none'; // Hide copy button in edit mode
      } else {
        // View mode
        altDisplay.textContent = imgData.alt || 'No description available.';
        copyAltBtn.style.display = 'inline-block';
      }
      
      altModal.style.display = 'block';
    }

    async function loadImages() {
      if (loading || !hasMore) return;
      loading = true;
      loadingEl.textContent = 'SYNCING DATA...';
      try {
        const res = await fetch(`/api/images?page=${page}&limit=8`);
        const data = await res.json();
        if (data.images && data.images.length > 0) {
          data.images.forEach(img => {
            // Track image for navigation
            const imgIndex = allImages.length;
            allImages.push(img);

            const item = document.createElement('div');
            item.className = 'gallery-item';

            const imageEl = document.createElement('img');
            imageEl.src = img.thumb || img.url; // Use thumbnail if available
            imageEl.alt = img.alt || '图片';
            imageEl.loading = 'lazy';
            imageEl.onclick = () => { openLightbox(imgIndex); };

            // Create ALT button wrapper
            // Only show ALT button if admin OR if there is content to show
            // User requested: "Remove export...". "Admin... edit".
            // I'll show it for admin always. For visitors, only if alt text exists.
            
            const btn = document.createElement('button');
            btn.className = 'alt-btn';
            btn.textContent = 'ALT';
            btn.onclick = (e) => {
              e.stopPropagation();
              showAlt(img, item);
            };
            
            // Logic: Always append, let click handler decide content? 
            // Or hide if not admin AND empty?
            // "Remove export...". This implies visitor shouldn't see "garbage" or raw metadata.
            // If empty, visitor sees nothing.
            // Since we load isAdmin async, we might render before we know.
            // But usually fetch is fast. To be safe, we can just append it.
            // If visitor and empty, maybe click shows "No description".
            
            item.appendChild(imageEl);
            item.appendChild(btn);
            gallery.appendChild(item);
          });
          page++;
          hasMore = data.hasMore;
          if (!hasMore) loadingEl.textContent = 'ALL DATA SYNCED';
        } else {
          hasMore = false;
          loadingEl.textContent = 'NO DATA FOUND';
        }
      } catch (err) {
        console.error('Load error:', err);
        loadingEl.textContent = 'CONNECTION ERROR';
      } finally {
        loading = false;
      }
    }

    const observer = new IntersectionObserver((entries) => {
      if (entries[0].isIntersecting) {
        loadImages();
      }
    }, { rootMargin: '100px' });
    observer.observe(loadingEl);

    copyAltBtn.onclick = () => {
      navigator.clipboard.writeText(altDisplay.textContent).then(() => {
        const t = copyAltBtn.textContent;
        copyAltBtn.textContent = 'COPIED!';
        setTimeout(() => copyAltBtn.textContent = t, 1500);
      });
    };

    closeModal.onclick = () => altModal.style.display = 'none';
    window.onclick = (e) => { if (e.target === altModal) altModal.style.display = 'none'; };
    // lightboxClose removed, handled by lbClose and background click above
    // document.addEventListener('keydown'...) handled above

    // Initial load
    loadImages();
  </script>
</body>
</html>
