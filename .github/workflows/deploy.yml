name: Deploy  BlogsEva

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_IP }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # 确保进入的是正确的目录
            cd /var/www/blog
            
            # 确认该目录确实是一个 git 仓库
            if [ ! -d ".git" ]; then
              echo "Error: /var/www/blog is not a git repository"
              exit 1
            fi

            git pull origin main
            npm install --production
            
            # 使用绝对路径启动 pm2 保证准确
            pm2 delete my-blog || true
            pm2 start /var/www/blog/server/app.js --name "my-blog" --env /var/www/blog/.env
            pm2 save