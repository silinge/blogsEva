name: Deploy  BlogsEva

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_IP }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # 1. 强制加载 NVM 环境 (假设你使用的是 nvm)
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" 
            
            # 2. 如果没用 nvm，尝试加载系统 profile
            source /etc/profile
            source ~/.bashrc

            # 3. 进入目录并执行
            cd /var/www/blog
            
            if [ ! -d ".git" ]; then
              echo "Error: /var/www/blog is not a git repository"
              exit 1
            fi

            git pull origin main
            
            # 现在 npm 和 pm2 应该可以被找到了
            npm install --production
            
            pm2 delete my-blog || true
            pm2 start /var/www/blog/server/app.js --name "my-blog" --env /var/www/blog/.env
            pm2 save